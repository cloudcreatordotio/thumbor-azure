[supervisord]
nodaemon=true
logfile=/app/logs/supervisord.log
pidfile=/app/logs/supervisord.pid
loglevel=info

[unix_http_server]
file=/app/logs/supervisor.sock
chmod=0770
chown=thumbor:thumbor

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=unix:///app/logs/supervisor.sock

# Redis Server
[program:redis]
command=/usr/bin/redis-server /etc/redis/redis.conf
user=redis
autostart=true
autorestart=true
priority=10
stdout_logfile=/app/logs/redis.log
stderr_logfile=/app/logs/redis-error.log
stdout_logfile_maxbytes=10MB
stderr_logfile_maxbytes=10MB
stdout_logfile_backups=2
stderr_logfile_backups=2
environment=PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"

# Thumbor Workers (4 processes as per original config)
[program:thumbor]
command=thumbor --port=800%(process_num)d --conf=/app/thumbor/thumbor.conf
user=thumbor
process_name=thumbor_%(process_num)d
numprocs=4
numprocs_start=1
autostart=true
autorestart=true
priority=20
startretries=3
startsecs=10
stdout_logfile=/app/logs/thumbor-%(process_num)d.log
stderr_logfile=/app/logs/thumbor-%(process_num)d-error.log
stdout_logfile_maxbytes=10MB
stderr_logfile_maxbytes=10MB
stdout_logfile_backups=2
stderr_logfile_backups=2
environment=PYTHONPATH="/app"

# RemoteCV for detection
[program:remotecv]
command=python3.11 -m remotecv.worker --host localhost --port 6379 --database 0 --store remotecv.result_store.redis_store --redis-mode single_node --redis-key-expire-time 3600
user=thumbor
autostart=true
autorestart=true
priority=30
startretries=3
startsecs=10
stdout_logfile=/app/logs/remotecv.log
stderr_logfile=/app/logs/remotecv-error.log
stdout_logfile_maxbytes=10MB
stderr_logfile_maxbytes=10MB
stdout_logfile_backups=2
stderr_logfile_backups=2
environment=PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin",PYTHONPATH="/app:/usr/local/lib/python3.11/dist-packages",REDIS_HOST="localhost",REDIS_PORT="6379",REDIS_DATABASE="0",LOG_LEVEL="info",DETECTOR_STORAGE="remotecv.result_store.redis_store"

# Redis Admin Web Interface
[program:redis-admin]
command=python3.11 /app/redis_admin.py
user=thumbor
autostart=true
autorestart=true
priority=35
startretries=3
startsecs=5
stdout_logfile=/app/logs/redis-admin.log
stderr_logfile=/app/logs/redis-admin-error.log
stdout_logfile_maxbytes=10MB
stderr_logfile_maxbytes=10MB
stdout_logfile_backups=2
stderr_logfile_backups=2
environment=PYTHONPATH="/app",REDIS_ADMIN_PORT="8888"

# Nginx Proxy with Cache
[program:nginx]
command=/usr/sbin/nginx
user=www-data
autostart=true
autorestart=true
priority=40
startretries=3
startsecs=5
stdout_logfile=/app/logs/nginx.log
stderr_logfile=/app/logs/nginx-error.log
stdout_logfile_maxbytes=10MB
stderr_logfile_maxbytes=10MB
stdout_logfile_backups=2
stderr_logfile_backups=2
environment=PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"

# Group for managing all services together
[group:thumbor-stack]
programs=redis,thumbor,remotecv,redis-admin,nginx
priority=999